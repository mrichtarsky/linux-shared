#!/usr/bin/env bash
set -eufo pipefail

if tmux list-sessions 2>/dev/null | grep window &>/dev/null
then
    export "`tmux showenv PATH`"
    if [[ "$OSTYPE" =~ ^darwin ]];
    then
        export "`tmux showenv VSCODE_GIT_IPC_HANDLE`"
    else
        export "`tmux showenv VSCODE_IPC_HOOK_CLI`"
    fi
fi

USER=$(whoami)

if [[ "$OSTYPE" =~ ^darwin ]];
then
    VSCODE_USER=$(gstat -c '%U' $VSCODE_GIT_IPC_HANDLE)
else
    VSCODE_USER=$(stat -c '%U' $VSCODE_IPC_HOOK_CLI)
fi

if [ "$VSCODE_USER" != "$USER" ]
then
    # Use vscode only when it can write to the file or dir
    # Only checking first file
    if ([ -f "$1" ] && sudo -u "$VSCODE_USER" test -w "$1") || ([ ! -f "$1" ] && sudo -u "$VSCODE_USER" test -w $(dirname "$1"))
    then
        code ${BLOCKING:-} "$@" &>/dev/null || mcedit "$@"
    else
        mcedit "$@"
    fi
else
    code ${BLOCKING:-} "$@" &>/dev/null || mcedit "$@"
fi
